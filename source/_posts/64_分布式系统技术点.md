---
title: 分布式系统技术点
date: 2020-04-07 21:30:39
categories:
- 分布式
---

## 高可用设计
- DNS 
  - 域名解析成IP
  - DNS提供商实现高可用
- CDN 
  - 静态文件的加速，没有数据的则回源
  - CDN提供商实现高可用
- LVS
  - 完成四层负载
  - KeepAlived 主备部署高可用
  - 性能极高
- Nginx 
  - 七层HTTP负载
  - 集群部署实现高可用
- gateway
  - 微服务网关
  - 实现统一鉴权日志等功能
  - 集群部署实现高可用
- 微服务
  - 无状态部署，实现业务逻辑
  - 集群部署
      - 实现高可用
  - 集群部署的要关注的技术点
    - 服务注册发现
    - 连接管理
    - 负载均衡
    - 节点探活
    - 失效处理
    
- 存储
    - 主从部署，读写分离
      - 一主一从
      - 一主多从
      - 延时从 
        - 利用延时从恢复被误操作的数据
    - 主从切换
      - 主库挂了之后 从库直接提升为主库 主库恢复之后 主库再恢复过来
      - 新主库预热问题
        - 内存没有热数据：控制入口流量
      - 业务无感知
            使用虚IP
    - 数据隔离
            不同业务模块使用不同数据库实例
- 模块拆分
  - 网关 + 按照业务垂直拆分
  - 拆分原则
    - 职责单一，业务隔离，粒度合理

## 高性能设计
- CDN
  - 边缘节点加速
- 业务逻辑优化
  - 使用合适的数据结构
  - 非必要耗时逻辑异步处理
- 部署优化
  - 使用合理JVM参数
  - 增加节点部署
- 存储性能优化
  - 使用缓存
    - 读多写少
    - cache aside
  - DB索引优化
  - 分库分表
    - 字段相关：取模
    - 其他字走映射表，比如手机号
    - 如果都是两个id都是自己生成 可以使用基因法 即两个id用于分表的bit保持一致，如商品发布逻辑，商品也分表，查询用户发布的所有商品
    - 冷热数据
      - 可以采用定时归档的措施
    - 时间相关
      - 按时间范围拆分 
        - 比如订单流水数据（不区分用户的）

## 服务治理
- 过载保护
  - 服务方超时丢弃
- 熔断降级
  - 返回失败降级
  - 调用方超时降级
  - 达到阈值熔断降级  
- 权重支持
  - 考虑到节点的性能差异
- 日常维护
  - 监控
    - 发现系统异常
    - 平均响应、TP99、TP95
- 调用链
  - 查找问题方便

## 一致性
- CAP
  - P
    - 分区容错性
    - 必须保证，因为任何分布式系统都可能出现网络不通的情况
  - C
    - 一致性
    - 想要保证一致性，就要等写操作同步完成之后才能拉取，没同步到不能拉取（网络延迟或者分区），这时就会导致不可用
  - A
    - 可用性
    - 想要保证可用性，就是任何时候都能拉取，这个时候就可能会拉到未同步的旧数据，就会影响一致性
  - 实践
    - 注册中心使用AP，因为不用保证各个节点拉到的完全一致
    - 配置中心使用CP，各个节点拉到的配置不一致，可能会发生业务错误

- 保证一致性的方式
  - 写
    - 永远都是写主，日志向从单向复制，写入超过半数可提交，因为过了半数之后，再次选举的时候，没有数据的是少数，不能被选为住，数据不会丢失
  - 读：
    - 只读主： 读到的永远都是最新的数据，但是会导致主压力大
    - 读主读从：先和主对比logindex，如果是最新的，直接返回数据，如果不是最新的，将请求转发到主，这样会减轻主的读压力

