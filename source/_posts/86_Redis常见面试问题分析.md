---
title: Redis常见面试问题分析
date: 2020-03-09 23:30:39
categories:
- Redis
tags:
- RDB
- AOF
- Codis
- 哨兵
- 集群
- LRU
- LFU
---

## 总体存储原理
- 每个DB分别保存着一个元素dict和过期时间dict,言外之意就是一个key会保存两次
- dict中的key是RedisObject，最终指向一个SDS（可变长度字符串）
- dict中的val也是RedisObject，最终指向各种各样的数据类型，比如sds ziplist skiplist dict hash list等

## 一个key占多大
- dicEntry 16b
- RedisObject 12b
- sds（长度+结束标记） 9b
- 最终大小
    - (16 + 12 + 9 + key)*2 *2是因为这个key在元素dict和过期dict中同时存在
    - key会存储2份，所以key不能过长 
        
## 内存如何清理
- 惰性删除
    - 查询时候发现过期了，直接删除
- 定期删除
    - Redis的事件循环中有定时任务专门处理删除过期key，但是不是全部扫描，而是随机选择删除
    - 从过期时间dict中随机选取数据，每轮选取20个数据，如果超过25%都是过期数据，则再进行一轮，如此循环，直到不达标或者超出限定时间
- 淘汰策略
    - 写入数据内存不足时触发淘汰策略
     - LRU
        RedisObject，里面保存着LRU时间，随机选取几个进行排序，然后进行删除时间最小的
        - allkeys
            - 所有key都参与淘汰
        - volatile（推荐）
            - 只有设置了过期时间的key会参与淘汰
                
     - LFU
        RedisObject，里面保存着LRU时间和使用频率（在一个字段中，24bit+8bit），随机选取几个进行排序（频率优先，时间其次），然后进行删除频率和时间最小的
        - allkeys
            - 所有key都参与淘汰
        - volatile（推荐）
            - 只有设置了过期时间的key会参与淘汰

## 内存持久化
- RDB 
    - fork子进程dump内存数据 m秒n次
    - 优点
        - 文件小
        - 恢复快
    - 缺点
        - cpu使用过高
        - 丢数据（耗费cpu 所以频率不能过高）
- AOF
    - 将命令追加到文件中
    - 优点
        - 丢数据少
    - 缺点
        - 占用空间大
        - 恢复慢
    - 重写
        - 去掉过期/删除数据 多次更新合一
        - 阈值判断
            - 日志文件体积满足最小重写大小
            - 日志文件体积比上次重写完成后增加的比例超过阈值
        - fork子进程重写，线上数据新数据写入aof_rewrite_buf 重新完成后将数据写入新aof文件
- 数据恢复
    - 默认是RDB， 但是AOF优先，没必要同时开启，AOF有覆盖RDB的可能性 如果要固化 推荐AOF（每秒1次刷盘）
    
## 高可用和扩展
- 主从模式
    - 实现原理
        - 全量快照同步，增量命令同步，根据从传给主的偏移量是否超过主内部的buffer来确定
    - 优点
        - 部署简单，能做数据备份
    - 缺点
        - 不能实现故障切换
    
- 哨兵模式（小数据量推荐）
    - 实现原理
        - 在主从的基础上增加了外部sentintel集群（也是redis）,监控主从运行状态，实现准备切换       
    - 优点
        - 可以实现自动切换
    - 缺点
        - 不支持水平扩展
- 集群模式
    - 实现原理
        - 每个节点（Master + Slave）维护一部分slot，每个节点知道其他节点维护的slot，可以进行重定向
    - 优点        
        - 支持水平扩容
    - 缺点
        - 有二次访问性能问题
        - 不能进行批量操作

- Codis（大数据量推荐）
    - 实现原理
        - 多个CodisSeverGroup（Redis主从），支持扩展，数据分片逻辑，注册到zk
        - CodisProxy（Redis协议代理），无状态，无限扩展，代理请求
        - Client -> [Haproxy 可有可无] -> CodisProxy ->  CodisSeverGroups
    - 优点
        - 支持水平扩展
        - 没有二次访问
        - 可以批量操作
    - 缺点
        - 部署复杂
