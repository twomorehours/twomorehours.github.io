---
title: InnoDB的索引实现
date: 2020-03-18 23:30:39
categories:
- MySQL
tags:
- InnoDB
- B+树
---

## Mysql数据目录结构
- Mysql的数据目录存储在变量`datadir`中
- 每个数据库有一个文件夹
- 文件夹中存放的是.frm(表结构)和.ibd(表数据), Mysql8以后都合并到.ibd中了
- 其他文件
  - 服务器进程文件
  - 服务器日志文件
  - SSL和RSA证书文件

## Mysql自带的数据库
- mysql
  - 存储用户信息，mysql自身的配置信息
- information_schema
  - 存储表的一些元数据，有哪些列，有哪些索引等
- performance_schema
  - 保存一些mysql运行期间的状态信息，是对mysql服务器的一个性能监控
- sys
  - 这个数据库通过把information_schema和performance_schema通过视图组合起来，更方便的查询性能信息

## B+树的结构
- 根节点
  - 根节点一旦创建就不会移动，始终页号不变
- 非叶子节点
  - 非叶子不存储真实的记录数据，只存储目录项，非叶子节点就是B+树的树干，同层不同节点使用双向链表连接
- 叶子节点
  - 叶子节点存储真实的记录数据，不同节点之间使用双向链表连接


## 索引分类
- 聚集索引
  - 聚集索引是主键索引，叶子节点存储的是真实的记录数据
- 二级索引
  - 二级索引是以指定字段顺序构建B+树，叶子节点存储的是主键的值，这样可以节省空间
- 联合索引
  - 联合索引是一种特殊的二级索引，是由多个字段组合而成的索引，生成一个B+树，排序优先级由钱到后依次降低，使用联合索引时要满足左前缀原则，当前缀不相同时会定位到不同的数据范围，不同的数据范围内的后面的索引也不一定是有序的

## 索引的损耗
- 索引需要占空间
- 增删改时需要维护索引，索引值变化时，导致索引数据移动到其他页，需要有移动成本，甚至会导致页分裂，导致更大的成本
- mysql在执行查询时需要先生成收集一些统计数据来执行计划，如果索引过多，对导致这段时间延长，甚至会降低查询速度

## 索引的作用
核心就是以空间换时间
- 快速定位到想要查询的数据范围
- 根据索引排序时，因为其本身有序，无需使用文件内排序

## 左前缀原则
左前缀原则是对使用联合索引的一个要求，因为联合索引是在一个范围内，前面字段控制的是整体顺序，后面字段控制的是局部顺序，只有前面字段固定了，后面的数据才是根据后面的字段有序的，才能进行二分或者排序，如果查询中没有前面的字段，或者前面的字段是一个范围，那么剩余的数据就是多个局部有序的数据段，无法定位到一个确定范围，全局无序，也不能直接用于排序


## 什么时候使用索引
- 某个字段需要被频繁查询
- 某个字段的基数要足够大
  - 基数就是这个字段所有的值去重后的个数，基数越大，没有索引的时候就需要将engine更多的数据返回给server，server进行过滤，加了索引之后，engine就会只把正确数据返回给server，返回正确数据的概率是原来全表扫描的基数倍。所以基数越大，收效月明显。这个基数具体多大取决于业务，一般来说userID的基数就足够大。

## 创建索引需要注意的情况
- 主键索引需要使用递增趋势的值，这样就不会发生页分裂，因为前面页不够就会新创建页
- 大字段尽量不要建索引，如长字符串，占用空间太大，如果非要用，可以使用前缀索引

## 索引的查询流程
先定位页，再定位数据
- 从根节点的slot二分查找，找到所属的组，然后从组内找到最后一个小于这个值的节点，根据页号调到下一层节点
- 重复上述步骤，一直到叶子节点
- 从叶子节点的slot查找，找到所属的组，然后遍历这个组内的值，找到匹配或者不匹配的

## 没有索引的查询流程
没有索引定位不到具体的数据范围，只能从叶子节点的第一页开始逐页逐条数据遍历，找到符合的
