---
title: awk基本使用
date: 2020-09-20 23:30:39
categories:
- Linux
---

## 啥是awk
awk是一个文本处理器，与sed, grep并称为文本处理三剑客。他们对文本的处理都是以`行`为单位的。sed一般用于修改文件，grep用于过滤文件，awk用于过滤文件和简单统计。

## 命令格式
```text
  awk    -F":"   'BEGIN{}  /pattern/{}   END{}'
  (1)    (2)       (3)       (4)    (5)    (6)
```
- 1. 一般用 `cat file | awk 'xxx'` or `awk 'xxx' file`
- 2. 分割符 默认是`\s+`,也就是任意个空格，可以用-F指定分割符号
- 3. BEGIN{} 这个里面的逻辑`仅在整个命令开始的时候执行一次`， 一般用于打印一些报表标题啥的，对于咱们查数据实际没啥太大用，有人说这里可以对一些全局变量初始化，但实际上awk的变量是不需要初始化的
- 4. /pattern/ 正则 `每行都执行` 满足正则的才会被后面的逻辑处理
- 5. 主要逻辑 `每行都执行` 这是最重要的地方 处理数据的逻辑都在这了
- 6. END{} 这个里面的逻辑`仅在整个命令结束的时候执行一次`，一般用于最终输出一些统计数据，这个还算有一些使用场景

## 两种输出
- print
  - 相当于println 可以有多个参数，都输出到一行，最后自动换行, 逗号分隔的话会显示成空格
- printf
  - 相当于printf 可以有多个参数，用逗号隔开 没有自动换行 如果需要自行添加\n
  - "%-ns" 代表以宽度n,左对齐输出字符串 如%-20s

## 变量
- $0
  - 整行数据
- $1 ~ $n
  - 切割后的字段 从1开始
- NF
  - Number Fields: 切割后共有几个字段
  - 一般取最后一个字段用$NF
- NR
  - Number Row: 当前行号
- 自定义变量
  - 不用初始化，拿来就用

## 小练习一
输出20.235上/etc/passwd中以uc开头的`行号`、`用户名`、`home目录`、`默认shell`, 如下
```text
行号   	用户名       	home                	shell     -- 这不是手写的
36   	uc_Dev01  	/home/uc_Dev01      	/bin/bash
37   	uc_Dev02  	/home/uc_Dev02      	/bin/bash
```

## 小练习二
输出20.235上/data/logs/uc.welfare_reward.http/web.reward.log中包含ActOrderRechargingRMQ的日志里面的那个json,如下
```text
{\"orderId\":\"222T21011121111132\",\"usr\":\"i1934976632\",\"amount\":1.00,\"rechargingType\":\"1\",\"status\":\"1\",\"date\":\"2021-01-11 11:13:53\",\"channel\":\"107105\",\"version\":\"17410003\",\"phoneModel\":\"OPPO+A57\",\"giftAmount\":\"0\",\"giftCoupon\":\"0\",\"giftCouponFlag\":false,\"originDesc\":\"福利卡充值\",\"p1\":\"Wv53n6VzTacDAMqKauVWK8zy\",\"imei\":\"__628459019253430\",\"orderOrigin\":\"yb_active_1_0\",\"oaid\":\"\",\"adid\":\"\",\"ip\":\"1.202.80.66\",\"p7\":\"__628459019253430\",\"userAgent\":\"okhttp/3.11.0\",\"pkgName\":\"\"}
...
```

## 小练习三
输出某slow log中redis的平均响应时间,如下
```text
平均响应时间: 21 ms
```

## 数组
```text
> echo "" | awk 'BEGIN {m["a"]+=1;m["b"]++;} END {for(k in m){print k,m[k]}}'
a 1
b 1
```
- awk数组是实际上就是map
- awk数组(任何变量)都我无需声明，直接使用
- 当map的value是数字时，可以直接用++ += -- -=
- 使用`for in`遍历


## 小练习四
输出8080端口的tcp连接状态，如下
```text
LISTEN 1
CLOSE_WAIT 53
ESTABLISHED 36
TIME_WAIT 5
```
## 小练习四
统计nginx.log中请求uri top5,如下
```text
/vp/order/giftOrdinaryVip 5
/vp/order/giftUnionVip 1
```
## substr
```text
> echo "断章取义" | awk '{print substr($0,2,2)}'
章取
```
- substr(str,index,length) index从1开始
## 小练习六
输出某slow log中redis的平均响应时长的key top5,如下
```text
vp_renew_job_lock_20 208.667
VIP_RENEW_LOCK_IOS_TEST 204.5
UVPE_G_i1076020015_3 88
USR_GRANT_COUPON_G 69.9565
GRANT_WELFARE_CARD_G 66.8182
```
